#!/bin/sh

# ./scripts/generate_manifest.sh <MANIFEST_PATH> <PREFIX>
# Example:
# ./scripts/generate_manifest.sh manifest_webapp.txt my-service:
# cat manifest_webapp.txt

MANIFEST_PATH=$1
PREFIX=$2
PYTHON=$3

## Write rpm packages.
rpm -qa --qf='%{sourcerpm}\n' | grep -v '(none)' | sort -u | sed 's/\.src\.rpm$//' > /tmp/all_rpms

### Select only packages installed in Dockerfile
INSTALLED=$(grep -h "yum.*install" Dockerfile* | tr " " "\n" | sort | uniq | grep . \
| grep -vE "(yum|-y|install|&&|\\\)")
for PKG in ${INSTALLED} redhat-release-server centos-release
do
    cat /tmp/all_rpms | grep "${PKG}-[0-9]" >> /tmp/filtered_rpms
done
sort /tmp/filtered_rpms | uniq > ${MANIFEST_PATH}

## Write Python packages if python set.
if [[ ! -z $PYTHON ]]
then
    $PYTHON -m pip freeze | sort > /tmp/pipdeps
    sed -i -e 's/^/'$PYTHON'-/' /tmp/pipdeps  # add 'python' prefix
    sed -i -e 's/==/-/' /tmp/pipdeps       # replace '==' with '-'
    sed -i -e 's/$/.pipfile/' /tmp/pipdeps # add '.pipfile' suffix
    cat /tmp/pipdeps >> ${MANIFEST_PATH}   # append python deps to manifest
fi

## Add prefix to all lines.
sed -i -e 's/^/'${PREFIX}'/' ${MANIFEST_PATH}
